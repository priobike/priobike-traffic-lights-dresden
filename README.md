# priobike-traffic-lights-dresden

This is a service that creates mocked traffic lights for Dresden and generates fake traffic light observations in the SensorThings API format. This can be used to test a GLOSA system when no real traffic lights data is available.

In Dresden, we also have physical test traffic lights. The control messages for those traffic lights are not generated by this service. The `src/converter.py` part of this repo can be used, however, to convert this kind of control messages to SensorThings API observations. Thus, they can be used in the same way as the fake traffic lights.

In the PrioBike project this is used for testing in Dresden.

[Learn more about PrioBike](https://github.com/priobike)

## Quickstart

### Prerequesites

Set the following environment variables:

Information about the FROST server, where the traffic lights will be inserted and the observations will be published to.
```bash
export FROST_BASE_URL=""
export FROST_MQTT_HOST=""
export FROST_MQTT_PORT=""
export FROST_MQTT_USER=""
export FROST_MQTT_PASS=""
```

Run the syncer once to insert the traffic lights into the FROST server. If the data of the FROST server is reset, this script needs to be run again.

```bash
python3 src/syncer.py
```

This script inserts traffic lights into the FROST server. Note that this script depends on the POST method to be allowed in the FROST server.

### Run using Docker

Create a `.env` file. Look at the `.env.example` file for reference.

Run the generator:
```bash
docker build -t priobike-traffic-lights-data-dresden-generator --target generator . && docker run --rm -it --env-file .env priobike-traffic-lights-data-dresden-generator
```

Run the converter:
```bash
docker build -t priobike-traffic-lights-data-dresden-converter --target converter . && docker run --rm -it --env-file .env priobike-traffic-lights-data-dresden-converter
```

### Run without Docker

Look at the following section.

## CLI

For the scripts, the following environment variables need to be set:

Information about the FROST server, where the traffic lights will be inserted and the observations will be published to.
```bash
export FROST_BASE_URL=""
export FROST_MQTT_HOST=""
export FROST_MQTT_PORT=""
export FROST_MQTT_USER=""
export FROST_MQTT_PASS=""
```

Information about the MQTT broker where the control messages (that should be converted) are published to.
```bash
export CTRLMESSAGES_MQTT_HOST=""
export CTRLMESSAGES_MQTT_PORT=""
export CTRLMESSAGES_MQTT_USER=""
export CTRLMESSAGES_MQTT_PASS=""
```

### Run the syncer

```bash
python3 src/syncer.py
```

This script inserts traffic lights into the FROST server. Note that this script depends on the POST method to be allowed in the FROST server.

### Run the generator

```bash
python3 src/generator.py
```

This script generates Observations based on pseudorandom traffic light programs. Note: the same traffic light will always get the same random program. The Observations are published to the FROST mqtt broker.

### Run the converter

```bash
python3 src/converter.py
```

This script converts the control messages from the TLS message converter arriving on a MQTT broker to Observations and publishes them to the FROST mqtt broker.

See: https://github.com/priobike/priobike-tls-controller

### Getting `locations.geojson`

Overpass turbo query

```overpass
/*
This query searches for traffic signals in Dresden, Germany, and includes the node IDs.
*/

[out:json];
// Define the area for Dresden
area[name="Dresden"]->.a;
// Search for nodes with the tag "highway" and value "traffic_signals" within the defined area
node["highway"="traffic_signals"](area.a);
out body;
>;
out skel qt;
```

### Getting `segments.geojson`

Overpass turbo query

```overpass
/*
This query searches for traffic signals in Dresden, Germany,
returns their location, direction, and associated road segment.
*/

[out:json];
// Define the area for Dresden
area[name="Dresden"]->.a;
// Search for nodes with the tag "highway" and value "traffic_signals" within the defined area,
// and include the direction tag
node["highway"="traffic_signals"](area.a);
// Find the road segments (ways) connected to the traffic signals
way(bn);
out body;
>;
out skel qt;
```

## Contributing

We highly encourage you to open an issue or a pull request. You can also use our repository freely with the `MIT` license. 

## Anything unclear?

Help us improve this documentation. If you have any problems or unclarities, feel free to open an issue.
